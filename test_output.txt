============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /Users/xiangyu/Library/CloudStorage/SeaDrive-XIANGYU(pan.xiangyu.pro)/My Libraries/projects/student-manage-system
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 4 items

tests/test_services.py .F..                                              [100%]

=================================== FAILURES ===================================
______________________________ test_login_success ______________________________

auth_service = <src.services.auth_service.AuthService object at 0x10353b950>
user_service = <src.services.user_service.UserService object at 0x1035a5bd0>

    def test_login_success(auth_service, user_service):
        # Ensure user exists (tests might run validation order, so best to create again or rely on fixture state)
        # Since we use module scope for DB but function scope for services (stateless), DB persists across tests in this file.
        # But test_create_user runs first usually.
        # Let's simple check if user needs creating
        if not user_service.get_user_by_account("admin"):
            user_service.create_user("admin", "admin", "password123", Identity.ADMIN)
    
        status, user, msg = auth_service.login("admin", "password123")
>       assert status == 3
E       assert -1 == 3

tests/test_services.py:75: AssertionError
----------------------------- Captured stdout call -----------------------------
src.services.auth_service - ERROR - Login error: Instance <User at 0x1035a0750> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)
------------------------------ Captured log call -------------------------------
ERROR    src.services.auth_service:auth_service.py:64 Login error: Instance <User at 0x1035a0750> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)
=========================== short test summary info ============================
FAILED tests/test_services.py::test_login_success - assert -1 == 3
========================= 1 failed, 3 passed in 0.73s ==========================
